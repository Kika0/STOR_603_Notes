---
title: "Compare_residual_margins"
output: html_document
date: "2024-09-24"
---

```{r setup, include=FALSE}
library(tidyverse)
library(latex2exp)
library(gridExtra)
library(gnorm)
library(VineCopula)
library(pracma) # incomplete gamma function, will be used later in cond.ext.model for modelling the residual margins
library(texmex) # air pollution data

knitr::opts_chunk$set(echo = TRUE)
# set theme defaults to be black rectangle
theme_set(theme_bw())
theme_replace(
  panel.spacing = unit(2, "lines"),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  strip.background = element_blank(),
  panel.border = element_rect(colour = "black", fill = NA) )
file.sources = list.files(pattern="*helpers.R")
sapply(file.sources,source,.GlobalEnv)
load("paramest.rda")
```

## Simulate data

Simulate from trivariate Markov chain with logistic copula links and Laplace margins.

```{r }
# set.seed(11)
# N <- 500
v <- 0.99 # threshold for conditioning variable
# sims <- generate_Y(N=N) %>% link_log(dep=1/2) %>%
#   link_log(dep=1/2) %>% link_log(dep=1/2) %>% link_log(dep=1/2) %>%
#   apply(c(1,2),FUN=frechet_laplace_pit) %>% as.data.frame()
```

## Motivate the problem

Simulate a $n=50000$ sample from a logistic distribution.

```{r}
# set.seed(12)
# N <- 50000
# v <- 0.99 # threshold for conditioning variable
# sims <- generate_Y(N=N) %>% link_log(dep=1/2) %>%
#   link_log(dep=1/2) %>% link_log(dep=1/2) %>% link_log(dep=1/2) %>%
#   apply(c(1,2),FUN=frechet_laplace_pit) %>% as.data.frame()
# obsr <- observed_residuals(df=sims,given=1,v=v)
# df <- data.frame(y=g_laplace(z=seq(-7.5,5,0.01),a=1/2),x=seq(-7.5,5,0.01))
# ggplot(obsr) + geom_density(mapping = aes(x=Z2)) + geom_line(data=df,mapping = aes(x=x,y=y),col="#C11432") + xlab(TeX("$Z_2$")) + ylab("Residual density function")
```

## Calculate MLE for different methods

All of the methods use use sequential estimates for $\alpha$ and then $\beta$ with both Keef constraints.

Likelihood ratio test compares two models with confidence levels obtained from $\chi^2$ distribution. This restricts the analysis to a pairwise comparison. We use AIC and NLLH (no penalty for the number of parameters) as metrics for each of the models.

```{r}
# L1 <- par_est(df=sims,v=v,given=c(1:5),margin = "Normal", method = "sequential2",keef_constraints = c(1,2))
# L2 <- par_est(df=sims,v=v,given=c(1:5),margin = "GenGaus", method = "sequential2",keef_constraints = c(1,2))
# L3 <- par_est(df=sims,v=v,given=c(1:5),margin = "AGGdelta", method = "sequential2",keef_constraints = c(1,2))
# L4 <- par_est(df=sims,v=v,given=c(1:5),margin = "AGGsig", method = "sequential2",keef_constraints = c(1,2))
# L5 <- par_est(df=sims,v=v,given=c(1:5),margin = "AGG", method = "sequential2",keef_constraints = c(1,2))
```

Compare the likelihood values for each conditioning variable and for each conditioning site.

```{r}
# L1 <- L1 %>% mutate(method="Normal",AIC=2*lik2+2*2)
# L2 <- L2 %>% mutate(method="GenGaus",AIC=2*lik2+2*3)
# L3 <- L3 %>% mutate(method="AGGdelta",AIC=2*lik2+2*4)
# L4 <- L4 %>% mutate(method="AGGsig",AIC=2*lik2+2*4)
# L5 <- L5 %>% mutate(method="AGG",AIC=2*lik2+2*5)
# 
# tmp <- rbind(L1,L2,L3,L4,L5) %>% mutate(method=factor(method),given=factor(as.character(given)),res=factor(as.character(res)))
```

Add 99 more iterations in a loop.

```{r}
# for (i in 2:100) {
# set.seed(12*i)
# N <- 50000
# v <- 0.99 # threshold for conditioning variable
# sims <- generate_Y(N=N) %>% link_log(dep=1/2) %>%
#   link_log(dep=1/2) %>% link_log(dep=1/2) %>% link_log(dep=1/2) %>%
#   apply(c(1,2),FUN=frechet_laplace_pit) %>% as.data.frame()
# L1 <- par_est(df=sims,v=v,given=c(1:5),margin = "Normal", method = "sequential2",keef_constraints = c(1,2))
# L2 <- par_est(df=sims,v=v,given=c(1:5),margin = "GenGaus", method = "sequential2",keef_constraints = c(1,2))
# L3 <- par_est(df=sims,v=v,given=c(1:5),margin = "AGGdelta", method = "sequential2",keef_constraints = c(1,2))
# L4 <- par_est(df=sims,v=v,given=c(1:5),margin = "AGGsig", method = "sequential2",keef_constraints = c(1,2))
# L5 <- par_est(df=sims,v=v,given=c(1:5),margin = "AGG", method = "sequential2",keef_constraints = c(1,2))
# L1 <- L1 %>% mutate(method="Normal",AIC=2*lik2+2*2)
# L2 <- L2 %>% mutate(method="GenGaus",AIC=2*lik2+2*3)
# L3 <- L3 %>% mutate(method="AGGdelta",AIC=2*lik2+2*4)
# L4 <- L4 %>% mutate(method="AGGsig",AIC=2*lik2+2*4)
# L5 <- L5 %>% mutate(method="AGG",AIC=2*lik2+2*5)
# 
# tmp <- rbind(tmp,rbind(L1,L2,L3,L4,L5) %>% mutate(method=factor(method),given=factor(as.character(given)),res=factor(as.character(res))))
# 
# }

pAIC <- ggplot(tmp) + geom_boxplot(aes(y=AIC,x=res,col=method)) + facet_wrap(~given,nrow=1) + scale_color_manual(values=c("Normal"="#070707","GenGaus"="#C11432","AGGdelta"="#009ADA","AGGsig"="#66A64F","AGG"="#FDD10A"))
pNLL <- ggplot(tmp) + geom_boxplot(aes(y=lik2,x=res,col=method)) + facet_wrap(~given,nrow=1) + scale_color_manual(values=c("Normal"="#070707","GenGaus"="#C11432","AGGdelta"="#009ADA","AGGsig"="#66A64F","AGG"="#FDD10A")) + ylab("Negative log-likelihood")
pa <- ggplot(tmp) + geom_boxplot(aes(y=a,x=res)) + facet_wrap(~given,nrow=1)
pb <- ggplot(tmp) + geom_boxplot(aes(y=b,x=res)) + facet_wrap(~given,nrow=1)
psig <- ggplot(tmp %>% filter(given=="1")) + geom_boxplot(aes(y=sig_agg,x=res,col=method)) + facet_wrap(~given,nrow=1)

ggsave(filename = "../Documents/AGG/AIC099.png",plot=pAIC,height=5,width=20)
ggsave(filename = "../Documents/AGG/NLL099.png",plot=pNLL,height=5,width=20)
```

Calculate also overall minimum AIC. In this metric, AGGsig has lowest mean AIC. However,we may

```{r}
tmpsum <- tmp %>% filter(given=="1") %>% mutate(ite=rep(1:100,each=20))%>% mutate(dependence=factor(abs(as.numeric(given)-as.numeric(res)))) %>% group_by(given,res,ite) %>% slice(which.min(AIC)) %>% group_by(method,dependence) %>% summarise(count=n()) %>% arrange(-count) 

pAICcount <- ggplot(tmpsum) + geom_bar(aes(x=reorder(method,-count),y=count,fill=dependence),position="stack",stat="identity") + scale_fill_manual(values=c("1"="#070707","2"="#C11432","3"="#009ADA","4"="#66A64F","5"="#FDD10A")) + xlab("Distribution for residual margin")

ggsave(filename = paste0("../Documents/AGG/AICcount",v*100,".png"),plot=pAICcount,height=5,width=7)
```

## Likelihood ratio test
Specifically compare considering different scale or shape parameter or both.
```{r}
N <- 50000
v <- 0.99
M <- 100
# L1 <- list()
# L2 <- list()
# L3 <- list()
# L4 <- list()
# for (i in 1:M) {
#   # simulate a sample
#   set.seed(12*i)
#   sims <- generate_Y(N=N) %>% link_log(dep=1/2) %>%
#     link_log(dep=1/2) %>% link_log(dep=1/2) %>% link_log(dep=1/2) %>%
#     apply(c(1,2),FUN=frechet_laplace_pit) %>% as.data.frame()
# # calculate log-likelihoods cond on 1 and save in a list
# L1[[i]] <- par_est(df=sims,v=v,given=c(1),margin = "GenGaus", method = "sequential2")
# L2[[i]] <- par_est(df=sims,v=v,given=c(1),margin = "AGGsig", method = "sequential2")
# L3[[i]] <- par_est(df=sims,v=v,given=c(1),margin = "AGG", method = "sequential2")
# L4[[i]] <- par_est(df=sims,v=v,given=c(1),margin = "AGGsigdelta", method = "sequential2")
# }

#save(L1,L2,L3,L4,tmp,file="paramest.rda")
# plot boxplots for likelihood
ablik <- c()
GenGaus <- c()
AGGsig <- c()
AGGdelta <- c()
AGGsigdelta <- c()
res <- rep(c("Z2","Z3","Z4","Z5"),length(L1))
for (i in 1:length(L1)) {
  ablik <- append(ablik,-as.numeric(unlist(L1[[i]]$lik)))
  GenGaus <- append(GenGaus,as.numeric(unlist(L1[[i]]$lik2)))
  AGGsig <- append(AGGsig,as.numeric(unlist(L2[[i]]$lik2)))  
  AGGdelta <- append(AGGdelta,as.numeric(unlist(L3[[i]]$lik2)))
  AGGsigdelta <- append(AGGsigdelta,as.numeric(unlist(L4[[i]]$lik2)))
}

# compare with the new data with Keef constraints (hence can be slightly different)
ggplot(tmp %>% filter(given=="1"))+ geom_boxplot(aes(x=res,y=lik2,col=method)) + scale_color_manual(values=c("Normal"="#070707","GenGaus"="#C11432","AGGdelta"="#009ADA","AGGsig"="#66A64F","AGG"="#FDD10A")) + ylab("Negative log-likelihood")
```

Now, plot likelihood ratio test values instead with $\chi^2$ distribution for critical values.

```{r}
AGG_GG <- 2*((tmp %>% filter(method=="GenGaus",given=="1") %>% pull(lik2))-(tmp %>% filter(method=="AGG",given=="1") %>% pull(lik2)) )
tmpagg <- data.frame(AGG_GG=AGG_GG,res=tmp %>% filter(method=="GenGaus",given=="1") %>% pull(res),given=tmp %>% filter(method=="GenGaus",given=="1") %>% pull(given))
p1 <- ggplot(tmpagg,aes(x=res,y=AGG_GG))+
  geom_boxplot() + xlab("Residuals") +
  # ylab("Different scale vs shape")
  ylab(TeX("$2(l_{AGG}(\\hat{\\mu},\\hat{\\sigma}_l,\\hat{\\sigma}_u,\\hat{\\delta}_l,\\hat{\\delta}_u)-l_{GG}(\\hat{\\mu},\\hat{\\sigma},\\hat{\\delta}))$")) + ylim(c(0,max(2*(AGGsigdelta-GenGaus)))) +
   geom_hline(yintercept = qchisq(0.95,2),linetype="dashed",col = "#66A64F") +  geom_hline(yintercept = qchisq(0.99,2),linetype="dashed", col= "#FDD10A")

AGGsig_GG <- 2*((tmp %>% filter(method=="GenGaus",given=="1") %>% pull(lik2))-(tmp %>% filter(method=="AGGsig",given=="1") %>% pull(lik2)) )
tmpagg <- data.frame(AGG_GG=AGGsig_GG,res=tmp %>% filter(method=="GenGaus",given=="1") %>% pull(res),given=tmp %>% filter(method=="AGGsig",given=="1") %>% pull(given))
p2 <- ggplot(tmpagg,aes(x=res,y=AGG_GG))+ 
  geom_boxplot() + xlab("Residuals") +
  # ylab("Different scale vs shape")
    ylab(TeX("$2(l_{AGG}(\\hat{\\mu},\\hat{\\sigma}_l,\\hat{\\sigma}_u,\\hat{\\delta}_c,\\hat{\\delta}_c)-l_{GG}(\\hat{\\mu},\\hat{\\sigma},\\hat{\\delta}))$"))  + ylim(c(0,max(2*(AGGsigdelta-GenGaus)))) +
   geom_hline(yintercept = qchisq(0.95,2),linetype="dashed",col = "#66A64F") +  geom_hline(yintercept = qchisq(0.99,2),linetype="dashed", col= "#FDD10A")

AGGdelta_GG <- 2*((tmp %>% filter(method=="GenGaus",given=="1") %>% pull(lik2))-(tmp %>% filter(method=="AGGdelta",given=="1") %>% pull(lik2)) )
tmpagg <- data.frame(AGG_GG=AGGdelta_GG,res=tmp %>% filter(method=="GenGaus",given=="1") %>% pull(res),given=tmp %>% filter(method=="GenGaus",given=="1") %>% pull(given))
p3 <- ggplot(tmpagg,aes(x=res,y=AGG_GG))+
  geom_boxplot() + xlab("Residuals") +
  # ylab("Different scale vs shape")
    ylab(TeX("$2(l_{AGG}(\\hat{\\mu},\\hat{\\sigma}_c,\\hat{\\sigma}_c,\\hat{\\delta}_l,\\hat{\\delta}_u)-l_{GG}(\\hat{\\mu},\\hat{\\sigma},\\hat{\\delta}))$"))+ ylim(c(0,max(2*(AGGsigdelta-GenGaus)))) +
   geom_hline(yintercept = qchisq(0.95,2),linetype="dashed",col = "#66A64F") +  geom_hline(yintercept = qchisq(0.99,2),linetype="dashed", col= "#FDD10A")
grid.arrange(p1,p2,p3,ncol=3)
```
Now plot shape parameter estimates to see improvement over no difference in the shape parameter for the lower and upper tail.
```{r}
d <- dl <- du <- c()
for (i in 1:length(L1)) {
 d <- append(d,as.numeric(unlist(L1[[i]]$delta)))
 dl <- append(dl,as.numeric(unlist(L4[[i]]$deltal)))
 du <- append(du,as.numeric(unlist(L4[[i]]$deltau)))  
}
p3 <- ggplot(data.frame(x=factor(res,levels=c("Z2","Z3","Z4","Z5")),y=d),aes(x=x,y=y))+
  geom_boxplot() + xlab("Residuals") + ylab(TeX("$\\hat{\\delta}$")) + ylim(c(1,4))
p1 <- ggplot(rbind(data.frame(x=factor(res,levels=c("Z2","Z3","Z4","Z5")),y=dl,z="dl"),data.frame(x=factor(res,levels=c("Z2","Z3","Z4","Z5")),y=du,z="du")),aes(x=x,y=y))+
  geom_boxplot(aes(fill=factor(z))) + xlab("Residuals")  + ylim(c(1,4)) +
  scale_fill_manual(values = c(dl="#66A64F",du="#009ADA"),labels = c(TeX("$\\hat{\\delta}_l$"),TeX("$\\hat{\\delta}_u$"))) + labs(fill = NULL,y = NULL) +
  theme(legend.key.size = unit(1.2, 'cm'), #change legend key size
       legend.text = element_text(size=15)) #change legend text font size

p2 <- ggplot(data.frame(x=factor(res,levels=c("Z2","Z3","Z4","Z5")),y=du),aes(x=x,y=y))+
  geom_boxplot() + xlab("Residuals") + ylab(TeX("$\\hat{\\delta}_u$")) + ylim(c(1,4))
grid.arrange(p3,p1,ncol=2,widths=c(1.4,2))
```
And do the same for the scale parameter.
```{r}
s <- sl <- su <- c()
for (i in 1:length(L1)) {
 s <- append(s,as.numeric(unlist(L1[[i]]$sig_agg)))
 sl <- append(sl,as.numeric(unlist(L4[[i]]$sigl)))
 su <- append(su,as.numeric(unlist(L4[[i]]$sigu)))  
}
p3 <- ggplot(data.frame(x=factor(res,levels=c("Z2","Z3","Z4","Z5")),y=s),aes(x=x,y=y))+
  geom_boxplot() + xlab("Residuals") + ylab(TeX("$\\hat{\\sigma}$")) + ylim(c(1,4))
p1 <- ggplot(rbind(data.frame(x=factor(res,levels=c("Z2","Z3","Z4","Z5")),y=sl,z="sl"),data.frame(x=factor(res,levels=c("Z2","Z3","Z4","Z5")),y=su,z="su")),aes(x=x,y=y))+
  geom_boxplot(aes(fill=factor(z))) + xlab("Residuals")  + ylim(c(1,4)) +
  scale_fill_manual(values = c(sl="#66A64F",su="#009ADA"),labels = c(TeX("$\\hat{\\sigma}_l$"),TeX("$\\hat{\\sigma}_u$"))) + labs(fill = NULL,y = NULL) +
  theme(legend.key.size = unit(1.2, 'cm'), #change legend key size
       legend.text = element_text(size=15)) #change legend text font size
grid.arrange(p3,p1,ncol=2,widths=c(1.4,2))
```
Compare $\hat{\alpha}$ and $\hat{\beta}$.

```{r}
p5 <- ggplot(data.frame(x=factor(res,levels=c("Z2","Z3","Z4","Z5")),y=ablik),aes(x=x,y=y))+
  geom_boxplot() + xlab("Residuals") + ylab(TeX("$l(\\hat{\\alpha},\\hat{\\beta},\\hat{\\mu},\\hat{\\sigma})$"))

a <- b <- c()
for (i in 1:length(L1)) {
 a <- append(a,as.numeric(unlist(L1[[i]]$a)))
 b <- append(b,as.numeric(unlist(L1[[i]]$b)))  
}

p1 <- ggplot(data.frame(x=factor(res,levels=c("Z2","Z3","Z4","Z5")),y=a),aes(x=x,y=y))+
  geom_boxplot() + xlab("Residuals") + ylab(TeX("$\\hat{\\alpha}$"))
p2 <- ggplot(data.frame(x=factor(res,levels=c("Z2","Z3","Z4","Z5")),y=b),aes(x=x,y=y))+
  geom_boxplot() + xlab("Residuals") + ylab(TeX("$\\hat{\\beta}$")) 
grid.arrange(p5,p1,p2,ncol=3)
```

## Pollution dataset application

```{r}
v <- 0.7
# transform to Laplace margins
winter_lap <- as.data.frame((winter %>% apply(c(2),FUN=row_number))/(nrow(winter)+1)) %>% apply(c(1,2),FUN=unif_laplace_pit) %>% as.data.frame()
summer_lap <- as.data.frame((summer %>% apply(c(2),FUN=row_number))/(nrow(summer)+1)) %>% apply(c(1,2),FUN=unif_laplace_pit) %>% as.data.frame()
```

Start with winter.

```{r}
L1 <- par_est(df=winter_lap,v=v,given=c(1:5),margin = "Normal", method = "sequential2",keef_constraints = c(1,2))
L2 <- par_est(df=winter_lap,v=v,given=c(1:5),margin = "GenGaus", method = "sequential2",keef_constraints = c(1,2))
L3 <- par_est(df=winter_lap,v=v,given=c(1:5),margin = "AGGdelta", method = "sequential2",keef_constraints = c(1,2))
L4 <- par_est(df=winter_lap,v=v,given=c(1:5),margin = "AGGsig", method = "sequential2",keef_constraints = c(1,2))
L5 <- par_est(df=winter_lap,v=v,given=c(1:5),margin = "AGG", method = "sequential2",keef_constraints = c(1,2))

L1 <- L1 %>% mutate(method="Normal",AIC=2*lik2+2*2)
L2 <- L2 %>% mutate(method="GenGaus",AIC=2*lik2+2*3)
L3 <- L3 %>% mutate(method="AGGdelta",AIC=2*lik2+2*4)
L4 <- L4 %>% mutate(method="AGGsig",AIC=2*lik2+2*4)
L5 <- L5 %>% mutate(method="AGG",AIC=2*lik2+2*5)

tmp <- rbind(L1,L2,L3,L4,L5) %>% mutate(method=factor(method),given=recode(factor(as.character(given)),"1"="O3","2"="NO2","3"="NO","4"="SO2","5"="PM10"),res=factor(as.character(res)))

pAIC <- ggplot(tmp) + geom_boxplot(aes(y=AIC,x=res,col=method)) + facet_wrap(~given,nrow=1) + scale_color_manual(values=c("Normal"="#070707","GenGaus"="#C11432","AGGdelta"="#009ADA","AGGsig"="#66A64F","AGG"="#FDD10A"))

ggsave(filename = "../Documents/AGG/AICwinter.png",plot=pAIC,height=5,width=20)

tmpsum <- tmp  %>% group_by(given,res) %>% slice(which.min(AIC)) %>% group_by(method) %>% summarise(count=n()) %>% arrange(-count) 

# pAICcount <- ggplot(tmpsum) + geom_bar(aes(x=reorder(method,-count),y=count),position="stack",stat="identity")  + xlab("Distribution for residual margin")
# 
# ggsave(filename = paste0("../Documents/AGG/AICcount",v*100,".png"),plot=pAICcount,height=5,width=7)
tmpsum
```

And then summer.

```{r}
L1s <- par_est(df=summer_lap,v=v,given=c(1:5),margin = "Normal", method = "sequential2",keef_constraints = c(1,2))
L2s <- par_est(df=summer_lap,v=v,given=c(1:5),margin = "GenGaus", method = "sequential2",keef_constraints = c(1,2))
L3s <- par_est(df=summer_lap,v=v,given=c(1:5),margin = "AGGdelta", method = "sequential2",keef_constraints = c(1,2))
L4s <- par_est(df=summer_lap,v=v,given=c(1:5),margin = "AGGsig", method = "sequential2",keef_constraints = c(1,2))
L5s <- par_est(df=summer_lap,v=v,given=c(1:5),margin = "AGG", method = "sequential2",keef_constraints = c(1,2))
```

Examine the AIC.

```{r}
L1s <- L1s %>% mutate(method="Normal",AIC=2*lik2+2*2)
L2s <- L2s %>% mutate(method="GenGaus",AIC=2*lik2+2*3)
L3s <- L3s %>% mutate(method="AGGdelta",AIC=2*lik2+2*4)
L4s <- L4s %>% mutate(method="AGGsig",AIC=2*lik2+2*4)
L5s <- L5s %>% mutate(method="AGG",AIC=2*lik2+2*5)

tmp <- rbind(L1s,L2s,L3s,L4s,L5s) %>% mutate(method=factor(method),given=recode(factor(as.character(given)),"1"="O3","2"="NO2","3"="NO","4"="SO2","5"="PM10"),res=factor(as.character(res)))

pAIC <- ggplot(tmp) + geom_boxplot(aes(y=AIC,x=res,col=method)) + facet_wrap(~given,nrow=1) + scale_color_manual(values=c("Normal"="#070707","GenGaus"="#C11432","AGGdelta"="#009ADA","AGGsig"="#66A64F","AGG"="#FDD10A"))

ggsave(filename = "../Documents/AGG/AICsummer.png",plot=pAIC,height=5,width=20)

tmpsum <- tmp  %>% group_by(given,res) %>% slice(which.min(AIC)) %>% group_by(method) %>% summarise(count=n()) %>% arrange(-count) 

# pAICcount <- ggplot(tmpsum) + geom_bar(aes(x=reorder(method,-count),y=count),position="stack",stat="identity")  + xlab("Distribution for residual margin")
# 
# ggsave(filename = paste0("../Documents/AGG/AICcount",v*100,".png"),plot=pAICcount,height=5,width=7)
tmpsum
```

