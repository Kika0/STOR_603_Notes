---
title: "Compare_residual_margins"
output: html_document
date: "2024-09-24"
---

```{r setup, include=FALSE}
library(tidyverse)
library(latex2exp)
knitr::opts_chunk$set(echo = TRUE)
# set theme defaults to be black rectangle
theme_set(theme_bw())
theme_replace(
  panel.spacing = unit(2, "lines"),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  strip.background = element_blank(),
  panel.border = element_rect(colour = "black", fill = NA) )
file.sources = list.files(pattern="*helpers.R")
sapply(file.sources,source,.GlobalEnv)
```

## Simulate data

Simulate from trivariate Markov chain with logistic copula links and Laplace margins.

```{r }
set.seed(11)
N <- 500
v <- 0.99 # threshold for conditioning variable
sims <- generate_Y(N=N) %>% link_log(dep=1/2) %>%
  link_log(dep=1/2) %>% link_log(dep=1/2) %>% link_log(dep=1/2) %>%
  apply(c(1,2),FUN=frechet_laplace_pit) %>% as.data.frame()
```

## Motivate the problem

Simulate a large sample from a logistic distribution.

```{r}
set.seed(11)
N <- 50000
v <- 0.99 # threshold for conditioning variable
sims <- generate_Y(N=N) %>% link_log(dep=1/2) %>%
  link_log(dep=1/2) %>% link_log(dep=1/2) %>% link_log(dep=1/2) %>%
  apply(c(1,2),FUN=frechet_laplace_pit) %>% as.data.frame()
obsr <- observed_residuals(df=sims,given=1,v=v)
df <- data.frame(y=g_laplace(z=seq(-7.5,5,0.01),a=1/2),x=seq(-7.5,5,0.01))
ggplot(obsr) + geom_density(mapping = aes(x=Z2)) + geom_line(data=df,mapping = aes(x=x,y=y),col="#C11432") + xlab(TeX("$Z_2$")) + ylab("Residual density function")
```

## Calculate MLE for different methods

```{r}
L1 <- par_est(df=sims,v=v,given=c(1:5),margin = "AGG", method = "two_step")
L2 <- par_est(df=sims,v=v,given=c(1:5),margin = "AGGsig", method = "two_step")
L3 <- par_est(df=sims,v=v,given=c(1:5),margin = "AGGsigdelta", method = "two_step")
# L3 <- par_est(df=sims,v=v,given=1,margin = "AGG", method = "two_step")$lik2
#par_est(df=sims,v=v,given=1,margin = "AGGsig", method = "two_step")$lik2

sum(2*((L2$lik2)-(L1$lik2))>pchisq(0.95,1))/nrow(L1)
sum(2*((L3$lik2)-(L2$lik2))>pchisq(0.99,1))/nrow(L1)
sum(2*((L3$lik2)-(L1$lik2))>pchisq(0.99,1))/nrow(L1)
2*((L2$lik2)-(L1$lik2))
2*((L3$lik2)-(L2$lik2))
2*((L3$lik2)-(L1$lik2))

```

Specifically compare considering different scale or shape parameter.

