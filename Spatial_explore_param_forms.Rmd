---
title: "Exploration of potential parametric forms of conditional extreme value models"
output: html_document
date: "2024-10-25"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(MASS)
library(tidyverse)
library(latex2exp)
library(viridis)
library(plgp)
library(gridExtra)
library(here)
library(tmap)
library(units)
library(sf)
theme_set(theme_bw())
theme_replace(
  panel.spacing = unit(2, "lines"),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  strip.background = element_blank(),
  panel.border = element_rect(colour = "black", fill = NA) )
```

## Set-up

Currently, we work with 19 years of daily maximum temperature data over summer months (June, July, August). (The issue with year 20 remains unresolved.)

```{r}

```

## Follow-up from meeting with Simon: exploring $\alpha$ against distance

Recall the plot of marginal estimates of $\alpha$ parameter againt distance[m] for the three conditioning sites. This is done using the sequential method (see below).

```{r, echo=FALSE}
# use parameteric form for a ----
# calculate distance from the 3 conditioning sites
# transform dataframe to include a vector of x (temperature) and d (distance from the conditioning site)
# p <- list()
# x <- list()
# d <- list()
# for (i in 1:3) {
#   cond_var <- i
# x[[i]] <- par_est(sims,v=0.9,given=c(cond_var),margin = "AGG", method="sequential")$a
# d[[i]] <- (ukcp18 %>% arrange(is_location))[-cond_var,] %>% select(4+cond_var) %>% pull() %>% units::drop_units()
# opt <- optim(par=c(0.01,0.1),fn=NLL_exp_norm_noise,x=x[[i]],d=d[[i]])
# # plot a function of alpha against distance
# a <- exp(-opt$par[1]*d[[i]])
# p[[i]] <- ggplot() + geom_line(data=data.frame(x=d[[i]],y=a),aes(x=x,y=y)) +
#   geom_point(data=data.frame(x=d[[i]],y=x[[i]]),aes(x=x,y=y)) +
#   ylab(TeX("$\\alpha$")) + xlab("Distance")
# }
# save(p,x,d,file = "alphaspatial.RData")
load("alphaspatial.RData")
```

```{r}
grid.arrange(p[[1]],p[[2]],p[[3]],ncol=3)
```

We look at Birmingham (left) and London (right).

```{r}
# pick a straight line as a divide: diff for each site 
is_above <- function(x,y) { y>(y2-y1)/(x2-x1)*(x-x1)+y1
}
# pick 2 points on a line for Birmingham
x1 <- 0
x2 <- 450000
y1 <- 1.2
y2 <- 0.25
df <- data.frame(x=d[[1]],y=x[[1]],z=as.character(is_above(d[[1]],x[[1]])))
p1 <- ggplot(df) + 
  geom_segment(x=x1,y=y1,xend=x2,yend=y2) +
   geom_point(aes(x=x,y=y,colour=factor(z))) + 
   ylab(TeX("$\\alpha$")) + xlab("Distance") + scale_color_manual(values = c("black", "#C11432")) + ggtitle("Birmingham")
# pick 2 points on a line for Birmingham
x1 <- 0
x2 <- 450000
y1 <- 1.2
y2 <- 0.25
df <- data.frame(x=d[[3]],y=x[[3]],z=as.character(is_above(d[[3]],x[[3]])))
p2 <- ggplot(df) + 
  geom_segment(x=x1,y=y1,xend=x2,yend=y2) +
   geom_point(aes(x=x,y=y,colour=factor(z))) + 
   ylab(TeX("$\\alpha$")) + xlab("Distance") + scale_color_manual(values = c("black", "#C11432")) + ggtitle("London")
# plot to check Birmingham and London
grid.arrange(p1,p2,ncol=2)
```
Link both back to spatial locations to explore any potential patterns.
```{r}

```

## Sequential parameter estimation

1. Fix $\beta=0$, estimate $\hat{\alpha}$.
2. Fix $\alpha=\hat{\alpha}$, estimate $\hat{\beta}$.
3. Fix $\alpha=\hat{\alpha}$ and $\beta=\hat{\beta}$, estimate $\hat{\mu}$ and $\hat{\sigma}$.
4. Calculate observed residuals, estimate $\hat{\mu}_{AGG}$, $\hat{\sigma}_{AGG}$, $\hat{\delta}_l$ and $\hat{\delta}_u$.


```{r}

```

## Conditioning on any random site

Currently, the analysis is conditioning on Birmingham, Glasgow and London, ordered as first 3 columns of the temperature data for an easy link. 