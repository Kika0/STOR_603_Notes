---
title: "Exploration of potential parametric forms of conditional extreme value models"
output: html_document
date: "2024-10-25"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(MASS)
library(tidyverse)
library(latex2exp)
library(viridis)
library(plgp)
library(gridExtra)
library(here)
library(tmap)
library(units)
library(sf)
theme_set(theme_bw())
theme_replace(
  panel.spacing = unit(2, "lines"),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  strip.background = element_blank(),
  panel.border = element_rect(colour = "black", fill = NA) )
```

## Set-up

Currently, we work with 19 years of daily maximum temperature data over summer months (June, July, August). (The issue with year 20 remains unresolved.)

```{r}

```

## Follow-up from meeting with Simon: exploring $\alpha$ against distance

Recall the plot of marginal estimates of $\alpha$ parameter againt distance[m] for the three conditioning sites. This is done using the sequential method (see below).

```{r, echo=FALSE}
# use parameteric form for a ----
# calculate distance from the 3 conditioning sites
# transform dataframe to include a vector of x (temperature) and d (distance from the conditioning site)
# p <- list()
# x <- list()
# d <- list()
# for (i in 1:3) {
#   cond_var <- i
# x[[i]] <- par_est(sims,v=0.9,given=c(cond_var),margin = "AGG", method="sequential")$a
# d[[i]] <- (ukcp18 %>% arrange(is_location))[-cond_var,] %>% select(4+cond_var) %>% pull() %>% units::drop_units()
# opt <- optim(par=c(0.01,0.1),fn=NLL_exp_norm_noise,x=x[[i]],d=d[[i]])
# # plot a function of alpha against distance
# a <- exp(-opt$par[1]*d[[i]])
# p[[i]] <- ggplot() + geom_line(data=data.frame(x=d[[i]],y=a),aes(x=x,y=y)) +
#   geom_point(data=data.frame(x=d[[i]],y=x[[i]]),aes(x=x,y=y)) +
#   ylab(TeX("$\\alpha$")) + xlab("Distance")
# }
# save(p,x,d,file = "alphaspatial.RData")
load("alphaspatial.RData")
```

```{r}
grid.arrange(p[[1]],p[[2]],p[[3]],ncol=3)
# simulate from the parametric form of alpha to compare with marginal fits

# pick a function of alpha as a divide: diff for each site 
l <- list()
l[[1]] <- -d[[1]]+50000
l[[2]] <- -d[[2]]+50000
l[[3]] <- -d[[3]]+50000
# plot to check

```

## Sequential parameter estimation

1. Fix $\beta=0$, estimate $\hat{\alpha}$.
2. Fix $\alpha=\hat{\alpha}$, estimate $\hat{\beta}$.
3a. Fix $\alpha=\hat{\alpha}$ and $\beta=\hat{\beta}$, estimate $\hat{\mu}$ and $\hat{\sigma}$.
3b. Calculate observed residuals, estimate $\hat{\mu_{AGG}}$, $\hat{\sigma_{AGG}}$, $\hat{\delta}_l$ and $\hat{\delta}_u$.


```{r}

```

## Conditioning on any random site

Currently, the analysis is conditioning on Birmingham, Glasgow and London, ordered as first 3 columns of the temperature data for an easy link. 